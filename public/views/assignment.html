<html>
    <head>
        <link rel=stylesheet href="/css/style.css" />
        <script src="/js/jquery.min.js"></script>
        <script src="/js/handlebars.js"></script>
        <script src="/js/inputParser.js"></script>
        
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                messageStyle: "none"
            });
        </script>
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
        <title>Assignment</title>
        
        <script id="template" type="text/x-handlebars-template">
            <header>
                <a href="/"><div class="button logo"></div></a>
                <div class="button-area">
                    {{#if user}}
                    <span class="greeting">Hello, <span class="username">{{user.data.name}}</span></span>
                    {{else}}
                    <span class="greeting">Not logged in &middot; <a href="/login">Login</a></span>
                    {{/if}}
                    <div class="button button-settings"></div>
                    <a href="/"><div class="button button-home"></div></a>
                </div>
            </header>
            <div class="main-area">
                <div class="sidebar">
                    {{#if user}}
                    <h2 class="sidebar-header">{{title}}</h2>
                    <ol class="questions">
                        {{#each questions}}
                        {{incrementPosition}}
                        <li class="clickable question-select" id="{{position}}"><div class="progress progress-{{progress}}" id="prog{{position}}"></div>{{title}}</li>
                        {{/each}}
                    </ol>
                    {{/if}}
                </div>
                {{resetPosition}}
                <div class="content-main">
                    {{#if user}}
                    {{#each questions}}
                    {{incrementPosition}}
                    <form class="question-container" id="q{{position}}">
                        <h2>{{title}}</h2>
                        
                        {{pushPosition}}
                        
                        {{#each parts}}
                        
                        {{incrementPosition}}
                        
                        {{#ifCond type "==" "content"}}
                        <p>{{content}}</p>
                        {{else}}
                        {{#ifCond type "==" "video"}}
                        <iframe width="560" height="315" src="//www.youtube.com/embed/{{url}}" frameborder="0" allowfullscreen></iframe>
                        {{else}}
                        {{#ifCond type "==" "image"}}
                        <img src="{{url}}" {{#if width}}width="{{width}}"{{/if}}/>
                        {{else}}
                        <div class="answer-area">
                            
                            {{#ifCond type "==" "radio"}}
                            {{pushPosition}}
                            {{#each choices}}
                            {{incrementPosition}}
                            <input type="radio" name="{{swapPosition}}p{{position}}{{swapPosition}}" value="{{position}}" /><label for="{{position}}">{{this}}</label><br />
                            {{/each}}
                            {{popPosition}}
                            {{/ifCond}}
                            
                            {{#ifCond type "==" "checkbox"}}
                            {{pushPosition}}
                            {{#each choices}}
                            {{incrementPosition}}
                            <input type="checkbox" name="{{swapPosition}}p{{position}}{{swapPosition}}" value="{{position}}" /><label for="{{position}}">{{this}}</label><br />
                            {{/each}}
                            {{popPosition}}
                            {{/ifCond}}
                            
                            {{#ifCond type "==" "numerical"}}
                            <input type="text" class="numerical" id="p{{position}}" /><span class="units">{{units}}</span>
                            <div class="errors" id="error{{position}}"></div>
                            {{/ifCond}}
                            
                            {{#ifCond type "==" "symbolic"}}
                            <div class="variable-list">
                                {{{listVariables variables}}}
                            </div>
                            <input type="text" class="symbolic" id="p{{position}}" />  
                            <div class="symbolic-render-area" id="render{{position}}"></div>
                            <div class="errors" id="error{{position}}"></div>
                            {{/ifCond}}
                            
                            {{#ifCond type "==" "dropdown"}}
                            <select id="p{{position}}">
                                {{pushPosition}}
                                {{#each choices}}
                                {{incrementPosition}}
                                <option value="{{position}}">{{this}}</option>
                                {{/each}}
                                {{popPosition}}
                            </select>
                            {{/ifCond}}
                        </div>
                        {{/ifCond}}
                        {{/ifCond}}
                        {{/ifCond}}
                        
                        {{/each}}
                        
                        
                        {{popPosition}}
                    </form>
                    {{/each}}
                    {{else}}
                    <p><a href="/login">Login</a> to complete assignments.</p>
                    {{/if}}
                </div>
            </div>
            <div class="hidden">
                \(\require{color}\)
                \(\definecolor{err}{RGB}{221, 75, 57}\)
            </div>
        </script>
        
        <script type="text/javascript">
            // TEMPORARY
            /*
            var data = {
                user: "Matthew",
                title: "Waves - The Final Frontier",
                questions: [
                    {
                        title: "Test Question",
                        progress: "00",
                        parts: [
                            {
                                type: "content",
                                content: "This is content-type."
                            },
                            {
                                type: "radio",
                                choices: [
                                    "This",
                                    "is",
                                    "radio",
                                    "type."
                                ]
                            },
                            {
                                type: "checkbox",
                                choices: [
                                    "This",
                                    "is",
                                    "checkbox",
                                    "type."
                                ]
                            },
                            {
                                type: "numerical",
                                units: "numerical type questions"
                            },
                            {
                                type: "symbolic",
                                variables: ["a", "b", "theta"]
                            },
                            {
                                type: "dropdown",
                                choices: [
                                    "This",
                                    "is",
                                    "dropdown",
                                    "type."
                                ]
                            },
                            {
                                type: "content",
                                content: "The following is a cute image of a kitten for testing purposes ONLY.  Any futher acknoledgement of the kitten's cuteness should be strictly avoided."
                            },
                            {
                                type: "image",
                                url: "http://takeinsocialmedia.com/wp-content/uploads/2014/02/cute-kitten-images-photos-0223204033.jpg"
                            },
                            {
                                type: "video",
                                url: "1-IKTtw335k"
                            }
                        ]
                    },
                    {
                        title: "The Only Question",
                        progress: "02",
                        parts: [
                            {
                                type: "content",
                                content: "This is the only part"
                            }
                        ]
                    },
                    {
                        title: "No It's Not",
                        progress: "05",
                        parts: [
                            {
                                type: "content",
                                content: "Haha sucka"
                            }
                        ]
                    }
                ]
            };
            */
            
            var data = {
                title: "Various Practice Problems",
                UID : 1,
                questions: [
                    {
                        title: "Railgun (Tipler6 28.P.041)",
                        progress: "00",
                        parts: [
                            {
                                type: "content",
                                content: "In the figure below, the rod has a mass \\(m\\) and a resistance \\(R\\).  The rails are horizontal, frictionless, and have negligible resistances.  The distance between the rails is \\(l\\).  An ideal battery that has an emf \\(E\\) is connected between points \\(a\\) and \\(b\\) so that the current in the rod is downward.  The rod is released at \\(t = 0\\)."
                            },
                            {
                                type: "image",
                                url: "https://dl.dropboxusercontent.com/u/3889893/sample1.gif",
                                width: 300
                            },
                            {
                                type: "content",
                                content: "Derive an expression for the force on the rod as a function of the speed.",
                            },
                            {
                                type: "symbolic",
                                variables: ["B", "R", "v", "l", "E"],
                                range: [[1,2],[1,2],[1,2],[1,2],[1,2]],
                                steps: 3,
                                answer: "l*B/R*(E-B*l*v)"
                            },
                            {
                                type: "content",
                                content: "Find an expression for the terminal speed of the rod."
                            },
                            {
                                type: "symbolic",
                                variables: ["B", "l", "E"],
                                range: [[1,2],[1,2],[1,2]],
                                steps: 3,
                                answer: "E/(b*l)"
                            }
                        ]
                    },
                    {
                        title: "Eddy Currents (Tipler6 26.P.038)",
                        progress: "00",
                        parts: [
                            {
                                type: "content",
                                content: "In the figure below, let \\(B = .8 \\mathrm{T}\\), \\(v = 11.0 \\mathrm{m/s}\\), \\(l = 22 \\mathrm{cm}\\), and \\(R = 2 \\mathrm{\\Omega}\\)."
                            },
                            {
                                type: "image",
                                url: "https://dl.dropboxusercontent.com/u/3889893/sample2.gif",
                                width: 300
                            },
                            {
                                type: "content",
                                content: "Find the induced EMF in the circuit.",
                            },
                            {
                                type: "numerical",
                                units: "V",
                                answer: "2"
                            },
                            {
                                type: "content",
                                content: "Find the current in the circuit."
                            },
                            {
                                type: "numerical",
                                units: "A",
                                answer: "1",
                            },
                            {
                                type: "content",
                                content: "In what direction is the current flowing?"
                            },
                            {
                                type: "radio",
                                choices: [
                                    "clockwise",
                                    "counterclockwise"
                                ],
                                answer: "1"
                            }
                        ]
                    }
                ]
            }
        </script>
        
        <script type="text/javascript">            
            var currentQuestion = "001";
            
            var loadQueue = [];
            var delay = null;
            
            var changeQuestion = function(question){
                if(currentQuestion == question){
                    return;
                }
                
                loadQueue.push([$(".question-container#q" + currentQuestion), "fadeOut"]);
                loadQueue.push([$(".question-container#q" + question), "fadeIn"]);
                
                processEventQueue();
                
                currentQuestion = question;
            }
            
            var processEventQueue = function(){
                if(delay == null && loadQueue.length > 0){
                    var func = loadQueue.shift();
                    func[0][func[1]](300);
                    func[0].blur();
                    delay = setTimeout(function(){
                        delay = null;
                        processEventQueue();
                    }, 300);
                }
            }
            
            var pad = function(n, width, z) {
                z = z || '0';
                n = n + '';
                return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
            }
            
            var user;
            
            var merge = function(a, b, prefix){
                a[prefix] = {}
                for(key in b){
                    a[prefix][key] = b[key];
                }
            }
            
            $(document).ready(function(){
                var req = new XMLHttpRequest();
                req.onload = ready;
                req.open("get", "/userinfo", true);
                req.send();
            });
            
            var ready = function(){
                user = JSON.parse(this.responseText);
                merge(data, user, "user");
                
                var positionCounter = 0;
                var positionStack = []
                
                Handlebars.registerHelper("position", function(){
                    return pad(positionCounter, 3);
                });
                
                Handlebars.registerHelper("incrementPosition", function(){
                    positionCounter++;
                    return "";
                });
                
                Handlebars.registerHelper("resetPosition", function(){
                    positionCounter = 0;
                    return "";
                });
                
                Handlebars.registerHelper("pushPosition", function(){
                    positionStack.push(positionCounter);
                    positionCounter = 0;
                    return "";
                });
                
                Handlebars.registerHelper("popPosition", function(){
                    positionCounter = positionStack.pop();
                    return "";
                });
                
                Handlebars.registerHelper("swapPosition", function(){
                    temp = positionStack.pop();
                    positionStack.push(positionCounter);
                    positionCounter = temp;
                    return "";
                });
                
                Handlebars.registerHelper("eq", function(a, b){
                    console.log("called on", a, b);
                    return a == b;
                });
                
                Handlebars.registerHelper("log", function(){
                    console.log("!!!");
                    return "";
                });
                
                Handlebars.registerHelper('ifCond', function (v1, operator, v2, options){
                    switch (operator){
                        case '==':
                            return (v1 == v2) ? options.fn(this) : options.inverse(this);
                        case '!=':
                            return (v1 != v2) ? options.fn(this) : options.inverse(this);
                        case '===':
                            return (v1 === v2) ? options.fn(this) : options.inverse(this);
                        case '<':
                            return (v1 < v2) ? options.fn(this) : options.inverse(this);
                        case '<=':
                            return (v1 <= v2) ? options.fn(this) : options.inverse(this);
                        case '>':
                            return (v1 > v2) ? options.fn(this) : options.inverse(this);
                        case '>=':
                            return (v1 >= v2) ? options.fn(this) : options.inverse(this);
                        case '&&':
                            return (v1 && v2) ? options.fn(this) : options.inverse(this);
                        case '||':
                            return (v1 || v2) ? options.fn(this) : options.inverse(this);
                        default:
                            return options.inverse(this);
                    }
                });
                
                Handlebars.registerHelper("listVariables", function(variables){
                    if(variables.length == 0){
                        return "<div class='hidden' id='variable-storage'></div>";
                    }
                    ret = "Use the following variables as necessary: ";
                    hidden = "<div class='hidden' id='variable-storage'>";
                    for(i = 0; i < variables.length; i++){
                        ret += "\\(" + variables[i] + "\\)";
                        hidden += "<span class='variable'>" + variables[i] + "</span>";
                        if(i < variables.length-1){
                            ret += ", ";
                        }
                    }
                    return ret + hidden + "</div>";
                });
                
                var out = $("body");
                var src = $("#template").html();
                
                var template = Handlebars.compile(src);
                var html = template(data);
                
                out.html(html);
                
                $(".question-select").click(function(e){
                    changeQuestion($(this).attr("id"));
                });
                
                MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
                
                $(".symbolic").bind("change keydown keyup", function(e){
                    console.log("yes");
                    renderId = "render" + $(this).attr("id").substring(1);
                    errorId = "error" + $(this).attr("id").substring(1);
                    
                    if(this.variables === undefined){
                        var varList = [];
                        variables = $(this).parent().children(".variable-list").children("#variable-storage").children(".variable").each(function(n, el){
                            varList.push($(el).text());
                        });
                        
                        this.variables = varList;
                    }
                    
                    console.log("VARLIST", this.variables);
                    
                    rendered = inputToLatex($(this).val(), this.variables);
                    $("#" + renderId).html("\\[" + rendered.latexString + "\\]");
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub, renderId]);
                    
                    if(rendered.errors.length == 0){
                        str = "";
                    } else if(rendered.errors.length == 1){
                        str = "<span class='bold title highlight'>1 Error:</span><br />" + rendered.errors[0];
                    } else if(rendered.errors.length <= 3){
                        str = "<span class='bold title highlight'>" + rendered.errors.length + " Errors:</span>";
                        for(i = 0; i < rendered.errors.length; i++){
                            str += "<br />" + rendered.errors[i];
                        }
                    } else {
                        str = "<span class='bold title highlight'>" + rendered.errors.length + " Errors:</span> <span class='subtitle'>(Showing first 3)</span>";
                        for(i = 0; i < 3; i++){
                            str += "<br />" + rendered.errors[i];
                        }
                    }
                    
                    $(this).parent().children(".errors").html(str);
                    
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub, errorId]);
                });
                
                $(".numerical").bind("change keydown keyup", function(e){
                    console.log($(this).val());
                    if(isNaN($(this).val())){
                        $(this).parent().children(".errors").html("<span class='bold title highlight'>Error: </span>Entered value is not a number.");
                    } else {
                        $(this).parent().children(".errors").html("");
                    }
                });
                // }
                
                //req.open("get", "/courses", true);
                //req.send();
            }
            
        </script>
    </head>
    <body></body>
</html>