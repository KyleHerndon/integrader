<html>
    <head>
        <link rel=stylesheet href="/css/style.css" />
        <script src="/js/jquery.min.js"></script>
        <script src="/js/handlebars.js"></script>
        <script src="/js/inputParser.js"></script>
        
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                messageStyle: "none"
            });
        </script>
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
        <title>Edit</title>
        
        <script id="template" type="text/x-handlebars-template">
            <header>
                <a href="/"><div class="button logo"></div></a>
                <div class="button-area">
                    {{#if user}}
                    <span class="greeting">Hello, <span class="username">{{user.data.name}}</span></span>
                    {{else}}
                    <span class="greeting">Not logged in &middot; <a href="/login">Login</a></span>
                    {{/if}}
                    <div class="button button-settings"></div>
                    <a href="/"><div class="button button-home"></div></a>
                </div>
            </header>
            <div class="main-area editing">
                <div class="sidebar">
                    {{#if user}}
                    <h2 class="sidebar-header">{{title}}</h2>
                    <ol class="questions">
                        {{#each questions}}
                        {{incrementPosition}}
                        <li class="clickable question-select" id="{{position}}"><div class="progress progress-{{progress}}" id="prog{{position}}"></div>{{title}}</li>
                        {{/each}}
                        {{incrementPosition}}
                        <li class="clickable question-select new-question" id="{{position}}">Add Question</li>
                    </ol>
                    {{/if}}
                </div>
                {{resetPosition}}
                <div class="content-main">
                    {{#if user}}
                    {{#each questions}}
                    {{incrementPosition}}
                    <form class="question-container" id="q{{position}}">
                        <h2>{{title}}</h2>
                        
                        {{pushPosition}}
                        
                        {{#each parts}}
                        
                        {{incrementPosition}}
                        
                        {{#ifCond type "==" "content"}}
                        <div class="content">
                        <p>{{content}}</p>
                            </div>
                        {{/ifCond}}
                        {{#ifCond type "==" "video"}}
                        <div class="video">
                        <iframe width="560" height="315" src="//www.youtube.com/embed/{{url}}" frameborder="0" allowfullscreen></iframe>
                            </div>
                        {{/ifCond}}
                        {{#ifCond type "==" "image"}}
                        <div class="image">
                            <img src="{{url}}" {{#if width}}width="{{width}}"{{/if}}/>
                            </div>
                        {{/ifCond}}
                            
                            {{#ifCond type "==" "radio"}}
                            {{pushPosition}}
                        <div class="answer-area radio">
                            {{#each choices}}
                            {{incrementPosition}}
                            <input type="radio" name="{{swapPosition}}p{{position}}{{swapPosition}}" value="{{position}}" /><label for="{{position}}">{{this}}</label><br />
                            {{/each}}
                            {{popPosition}}
                            </div>
                            {{/ifCond}}
                            
                            {{#ifCond type "==" "checkbox"}}
                            {{pushPosition}}
                            <div class="answer-area checkbox">
                            {{#each choices}}
                            {{incrementPosition}}
                            <input type="checkbox" name="{{swapPosition}}p{{position}}{{swapPosition}}" value="{{position}}" /><label for="{{position}}">{{this}}</label><br />
                            {{/each}}
                                </div>
                            {{popPosition}}
                            {{/ifCond}}
                            
                            {{#ifCond type "==" "numerical"}}
                                <div class="answer-area numerical">
                            <input type="text" class="numerical" id="p{{position}}" /><span class="units">{{units}}</span>
                            <div class="errors" id="error{{position}}"></div>
                                    </div>
                            {{/ifCond}}
                            
                            {{#ifCond type "==" "symbolic"}}
                                    <div class="answer-area symbolic">
                            <div class="variable-list">
                                {{{listVariables variables}}}
                            </div>
                            <input type="text" class="symbolic" id="p{{position}}" />  
                            <div class="symbolic-render-area" id="render{{position}}"></div>
                            <div class="errors" id="error{{position}}"></div>
                                        </div>
                            {{/ifCond}}
                            
                            {{#ifCond type "==" "dropdown"}}
                                        <div class="answer-area dropdown">
                            <select id="p{{position}}">
                                {{pushPosition}}
                                {{#each choices}}
                                {{incrementPosition}}
                                <option value="{{position}}">{{this}}</option>
                                {{/each}}
                                {{popPosition}}
                            </select>
                                            </div>
                            {{/ifCond}}
                        
                        {{/each}}
                        
                        
                        {{popPosition}}
                    </form>
                    {{/each}}
                    {{else}}
                    <p><a href="/login">Login</a> to complete assignments.</p>
                    {{/if}}
                </div>
            </div>
            <div class="hidden">
                \(\require{color}\)
                \(\definecolor{err}{RGB}{221, 75, 57}\)
            </div>
        </script>
        
        <script type="text/javascript">
            // TEMPORARY
            
            var data = {
                title: "Various Practice Problems",
                UID : 1,
                questions: [
                    {
                        title: "Railgun (Tipler6 28.P.041)",
                        progress: "00",
                        parts: [
                            {
                                type: "content",
                                content: "In the figure below, the rod has a mass \\(m\\) and a resistance \\(R\\).  The rails are horizontal, frictionless, and have negligible resistances.  The distance between the rails is \\(l\\).  An ideal battery that has an emf \\(E\\) is connected between points \\(a\\) and \\(b\\) so that the current in the rod is downward.  The rod is released at \\(t = 0\\)."
                            },
                            {
                                type: "image",
                                url: "https://dl.dropboxusercontent.com/u/3889893/sample1.gif",
                                width: 300
                            },
                            {
                                type: "content",
                                content: "Derive an expression for the force on the rod as a function of the speed.",
                            },
                            {
                                type: "symbolic",
                                variables: ["B", "R", "v", "l", "E"],
                                range: [[1,2],[1,2],[1,2],[1,2],[1,2]],
                                steps: 3,
                                answer: "l*B/R*(E-B*l*v)"
                            },
                            {
                                type: "content",
                                content: "Find an expression for the terminal speed of the rod."
                            },
                            {
                                type: "symbolic",
                                variables: ["B", "l", "E"],
                                range: [[1,2],[1,2],[1,2]],
                                steps: 3,
                                answer: "E/(b*l)"
                            }
                        ]
                    },
                    {
                        title: "Eddy Currents (Tipler6 26.P.038)",
                        progress: "00",
                        parts: [
                            {
                                type: "content",
                                content: "In the figure below, let \\(B = .8 \\mathrm{T}\\), \\(v = 11.0 \\mathrm{m/s}\\), \\(l = 22 \\mathrm{cm}\\), and \\(R = 2 \\mathrm{\\Omega}\\)."
                            },
                            {
                                type: "image",
                                url: "https://dl.dropboxusercontent.com/u/3889893/sample2.gif",
                                width: 300
                            },
                            {
                                type: "content",
                                content: "Find the induced EMF in the circuit.",
                            },
                            {
                                type: "numerical",
                                units: "V",
                                answer: "2"
                            },
                            {
                                type: "content",
                                content: "Find the current in the circuit."
                            },
                            {
                                type: "numerical",
                                units: "A",
                                answer: "1",
                            },
                            {
                                type: "content",
                                content: "In what direction is the current flowing?"
                            },
                            {
                                type: "radio",
                                choices: [
                                    "clockwise",
                                    "counterclockwise"
                                ],
                                answer: "1"
                            }
                        ]
                    }
                ]
            }
        </script>
        
        <script type="text/javascript">            
            var currentQuestion = "001";
            
            var loadQueue = [];
            var delay = null;
            
            var changeQuestion = function(question){
                if(currentQuestion == question){
                    return;
                }
                
                loadQueue.push([$(".question-container#q" + currentQuestion), "fadeOut"]);
                loadQueue.push([$(".question-container#q" + question), "fadeIn"]);
                
                processEventQueue();
                
                currentQuestion = question;
            }
            
            var processEventQueue = function(){
                if(delay == null && loadQueue.length > 0){
                    var func = loadQueue.shift();
                    func[0][func[1]](300);
                    func[0].blur();
                    delay = setTimeout(function(){
                        delay = null;
                        processEventQueue();
                    }, 300);
                }
            }
            
            var pad = function(n, width, z) {
                z = z || '0';
                n = n + '';
                return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
            }
            
            var user;
            
            var merge = function(a, b, prefix){
                a[prefix] = {}
                for(key in b){
                    a[prefix][key] = b[key];
                }
            }
            
            $(document).ready(function(){
                var req = new XMLHttpRequest();
                req.onload = ready;
                req.open("get", "/userinfo", true);
                req.send();
            });
            
            var ready = function(){
                user = JSON.parse(this.responseText);
                merge(data, user, "user");
                
                var positionCounter = 0;
                var positionStack = []
                
                Handlebars.registerHelper("position", function(){
                    return pad(positionCounter, 3);
                });
                
                Handlebars.registerHelper("incrementPosition", function(){
                    positionCounter++;
                    return "";
                });
                
                Handlebars.registerHelper("resetPosition", function(){
                    positionCounter = 0;
                    return "";
                });
                
                Handlebars.registerHelper("pushPosition", function(){
                    positionStack.push(positionCounter);
                    positionCounter = 0;
                    return "";
                });
                
                Handlebars.registerHelper("popPosition", function(){
                    positionCounter = positionStack.pop();
                    return "";
                });
                
                Handlebars.registerHelper("swapPosition", function(){
                    temp = positionStack.pop();
                    positionStack.push(positionCounter);
                    positionCounter = temp;
                    return "";
                });
                
                Handlebars.registerHelper("eq", function(a, b){
                    console.log("called on", a, b);
                    return a == b;
                });
                
                Handlebars.registerHelper("log", function(){
                    console.log("!!!");
                    return "";
                });
                
                Handlebars.registerHelper('ifCond', function (v1, operator, v2, options){
                    switch (operator){
                        case '==':
                            return (v1 == v2) ? options.fn(this) : options.inverse(this);
                        case '!=':
                            return (v1 != v2) ? options.fn(this) : options.inverse(this);
                        case '===':
                            return (v1 === v2) ? options.fn(this) : options.inverse(this);
                        case '<':
                            return (v1 < v2) ? options.fn(this) : options.inverse(this);
                        case '<=':
                            return (v1 <= v2) ? options.fn(this) : options.inverse(this);
                        case '>':
                            return (v1 > v2) ? options.fn(this) : options.inverse(this);
                        case '>=':
                            return (v1 >= v2) ? options.fn(this) : options.inverse(this);
                        case '&&':
                            return (v1 && v2) ? options.fn(this) : options.inverse(this);
                        case '||':
                            return (v1 || v2) ? options.fn(this) : options.inverse(this);
                        default:
                            return options.inverse(this);
                    }
                });
                
                Handlebars.registerHelper("listVariables", function(variables){
                    if(variables.length == 0){
                        return "<div class='hidden' id='variable-storage'></div>";
                    }
                    ret = "Use the following variables as necessary: ";
                    hidden = "<div class='hidden' id='variable-storage'>";
                    for(i = 0; i < variables.length; i++){
                        ret += "\\(" + variables[i] + "\\)";
                        hidden += "<span class='variable'>" + variables[i] + "</span>";
                        if(i < variables.length-1){
                            ret += ", ";
                        }
                    }
                    return ret + hidden + "</div>";
                });
                
                var out = $("body");
                var src = $("#template").html();
                
                var template = Handlebars.compile(src);
                var html = template(data);
                
                out.html(html);
                
                var onQuestionClick = function(e){
                    if($(this).hasClass("new-question")){
                        id = $(this).attr("id");
                        nid = pad(parseInt(id)+1, 3);
                        
                        $(this).removeClass("new-question");
                        $(this).html("<div class='progress progress-00'></div>" + $(this).html());
                        
                        $(".content-main").append("<form class='question-container' id='q" + id + "'><h2>New Question</h2></form>");
                        $(this).parent().append("<li class='clickable question-select new-question' id='" + nid + "'>Add Question</li>");
                        $(".new-question").click(onQuestionClick);
                    }
                    changeQuestion($(this).attr("id"));
                }
                
                $(".question-select").click(onQuestionClick);
                
                $(".editing div.content-main form>div").click(function(e){
                    $(this).addClass("edit");
                }).blur(function(e){
                    $(this).removeClass("edit");
                });
                
                $(".editing div.content-main form>h2").click(function(e){
                    $(this).addClass("edit");
                }).blur(function(e){
                    $(this).removeClass("edit");
                });
            }
            
        </script>
    </head>
    <body></body>
</html>